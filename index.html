<html>

    <head>
        <title>Twitter Vocabulary Builder</title>
        <style>
            
            body {
                margin: 0px;
            }
            h1{ 
                color: white;
                background-color: #000;
                padding-left: 10px;
                padding-top: 10px;
                font-family: sans-serif;
            }
            h2 {
              color: black;  
                font-weight: bold;
                font-family: sans-serif;
                padding-top: 0px;
                padding-left: 10px;
            }
           
            ul {
               list-style: none;
                font-family: sans-serif;
                font-weight: 500;
                padding-left: 0px;
                
            }
            
            ul li:hover{
                list-style: none;
                background-color: #ccc;
                
            }
            
            li{
                list-style: none;
                font-family: Arial;
                
                
            }
            
            #main_div{  
               width: 1500px; 
              height: 760px; 
              border:1px solid black;
                overflow:auto;
            }
            
            
            #current_terms{  
               width: 1495px; 
              height: 40px; 
              border:1px solid black;
                overflow:auto;
                float:top;
            }
            
            
            
            #current_terms input {
                background-color: #4CAF50;
                border: none;
                color: white;
                padding: 5px 5px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                margin: 4px 2px;
                cursor: pointer;
            }
            
            #live_tweets{
              float: left;  
               width: 300px; 
              height: 710px; 
              border:1px solid black;
                overflow:auto;
            }
            
            #contents{  
              width: 290px; 
              height: 640px;
                overflow:auto;
                padding-left: 5px;
            }
            
            #bars{
              float: right;
              width: 1100px; 
              height: 500px;
            }
            
            #bars1{
                margin-top: 20px;  
                margin-right: 20px;  
                margin-bottom: 20px;  
                margin-left: 20px;
            }
            
            #bars2{
                margin-top: 20px;  
                margin-right: 20px;  
                margin-bottom: 20px;  
                margin-left: 20px;
            }
            
            #bars1_div{
              float: left;
                
            }
            
            #bars2_div{
              float: right;
                
            }
            
            
            
            #bars rect {
                fill: steelblue;
                box-shadow: 2px 2px 2px #666;
                
            }
            
        
            
            
            
        </style>
    </head>

    <body>
        <h1>Twitter Vocabulary Builder</h1>
        <label>Search Terms: </label>
            <input type="text" id="textInput"/>
            <button type="button" onclick="startSearch();">Add/Twitterify</button>
            <button type="button" onclick="resetSearch();">New Search</button>
        <label>Add terms seperated by semicolon (;) </label>
        <button type="button" onclick="exportData();">Export Keywords</button> 
        
        <form>
          <div class="dropMenuDIV">
            <select id="dropMenu" onchange="menuChange()">
              <option value="0">Choose your answer</option>
              <option value="3">3 days</option>
              <option value=10>1 week</option>
              <option value="20">2 weeks</option>
              <option value="100">1 month</option>
              <option value="200">2 months</option>
            </select>
          </div>
        </form>
        
        <hr>
        <div id="main_div">
            <div id="current_terms" >
            <label>Current Terms: </label>
            </div>
            <div id="live_tweets">
               <h2>Live Tweets</h2> 
            <div id="contents" ></div>
            </div>
        
            <div id="bars" width="1000" height="1000">
                <div id="bars1_div">
                    <h2>Frequency</h2>
                <svg id="bars1"></svg>
                </div>
                <div id="bars2_div">
                    <h2>Significance</h2>
                <svg id="bars2"></svg>
                </div>
            </div>    
        
        </div>
    </body>
    
    
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://alasql.org/console/alasql.min.js"></script>
    
    <script src="stopWords.js"></script>
    
    <script>
    
    //    http://underscorejs.org/#
        
    //    http://viralpatel.net/blogs/dynamic-add-textbox-input-button-radio-element-html-javascript/
    function resetSearch() {
     
        clearInterval(interval);
        
        d3.select("#contents").selectAll("*").remove();
        d3.select("#bars1").selectAll("*").remove();
        d3.select("#bars2").selectAll("*").remove();
        
        countWords.query.terms.text=[];
        significantWords.query.terms.text=[]; 
        query.query.terms.text=[];
                
        //console.log(countWords);
        
        
    }
        
        
        
        var first_interval = setInterval(function() {
            //console.log("calling");
            
            d3.json("http://vgc.poly.edu/projects/es-gateway/twitter/_search")
            .header("Content-Type", "application/json")
            .post(JSON.stringify(query2), liveData);

            }, 10000)
        
    
    
    </script>
    
  <script>
    
    function addButton(keyword) {
     console.log("adding button");
    //Create an input type dynamically.
        var kwd= "term";
    var element = document.createElement("input");
 
    //Assign different attributes to the element.
    element.setAttribute("type", "button");
    element.setAttribute("value", keyword);
    element.setAttribute("id", kwd.concat(keyword));
    element.setAttribute("onclick","removeButton(this)");
        console.log(element.id);
        //element.innnerHTML=keyword;
 
 
    var foo = document.getElementById("current_terms");
 
    //Append the element in page (in span).
    foo.appendChild(element);
 
    }
      
      function removeButton(node) {
          var foo = document.getElementById("current_terms");
          var child= document.getElementById(node.id);
          foo.removeChild(child);
          
          indx=query.query.terms.text.indexOf(node.value);
          
          countWords.query.terms.text.splice(indx,1);
          significantWords.query.terms.text.splice(indx,1);
          query.query.terms.text.splice(indx,1);
          
          renderAll();
          
      }
      
      
      function exportData(){
          
         alasql("SELECT * INTO CSV('keywords.csv') FROM ?",[[query.query.terms.text]]);   
          
          
      }
      
       function menuChange(){
         
           var menuValue=document.getElementById("dropMenu").value;
           
           console.log(menuValue);
           
       }
    
    
    
    </script>  
    
    <script>
        
        var interval;
        
        
        function startSearch() {
        //console.log(countWords);
            clearInterval(interval);
            clearInterval(first_interval);
        var searchText=document.getElementById("textInput").value;
            
        if (searchText!=""){    
        var keywordArray=searchText.split(';');  
            
            for (i =0; i<keywordArray.length; i++){
                
                if (keywordArray[i].trim()!=""){
                    
                    countWords.query.terms.text.push(keywordArray[i].trim());
                    significantWords.query.terms.text.push(keywordArray[i].trim()); 
                    query.query.terms.text.push(keywordArray[i].trim());
                    
                    addButton(keywordArray[i].trim());
                    
                }
                
                }
        //console.log(countWords);
        document.getElementById("textInput").value="";
        
        
            renderAll();
            
        }
            
        }
        
        function renderAll(){
        
            //document.getElementById("currentTerms").innerHTML=query.query.terms.text;
            
         d3.json("http://vgc.poly.edu/projects/es-gateway/twitter/_search")
            .header("Content-Type", "application/json")
            .post(JSON.stringify(query), liveData);

         d3.json("http://vgc.poly.edu/projects/es-gateway/twitter/_search")
                .header("Content-Type", "application/json")
                .post(JSON.stringify(countWords), countData);

         d3.json("http://vgc.poly.edu/projects/es-gateway/twitter/_search")
                .header("Content-Type", "application/json")
                .post(JSON.stringify(significantWords), significantData);   
            
            
            
        interval = setInterval(function() {
            //console.log("calling");
            
            d3.json("http://vgc.poly.edu/projects/es-gateway/twitter/_search")
            .header("Content-Type", "application/json")
            .post(JSON.stringify(query), liveData);

            d3.json("http://vgc.poly.edu/projects/es-gateway/twitter/_search")
                .header("Content-Type", "application/json")
                .post(JSON.stringify(countWords), countData);

            d3.json("http://vgc.poly.edu/projects/es-gateway/twitter/_search")
                .header("Content-Type", "application/json")
                .post(JSON.stringify(significantWords), significantData);
            }, 10000)    
            
            
            
    }
    </script>
    
    
    <script>
        
        var query = {
        size: 10,
        "query": {
                 "terms" : { "text" : []}  
            },    
        sort: [
          {"@timestamp" : {"order" : "desc"}}
       ]
    }
        
        var query2 = {
        size: 10,    
        sort: [
          {"@timestamp" : {"order" : "desc"}}
       ]
    }
    
        var countWords = {
            "query": {
                 "terms" : { "text" : []}  
            },
            
            size: 10,
            "aggs": {
                "TopWords": {
                    "terms": {
                        "field": "text",
                        "size": 50,
                        exclude: stopWords

                    }
                }
            }   
        }

        var significantWords = {
            "query": {
                 "terms" : { "text" : []}  
            },
            "aggs": {
                "TopWords": {
                    "significant_terms": {
                        "gnd": {},
                        "field": "text",
                        "size": 50,
                        exclude: stopWords

                    }
                }
            }   
        }
        
        function liveData(error, data) {
            
            //console.log(data.hits.hits);
        
            d3.select("#contents").selectAll("*").remove();
           var changes = d3.select("#contents")
                .selectAll("li")
                .data(data.hits.hits, function(d) { return d._id});
            
            
           
           changes.enter()
                .append("li")
                .text(function(d) {return d._source.text});
                    // .on("mouseenter",function(d, i) { highlight(d.name);})
                    // .on("mouseleave",function(d, i) { unHighlight();})
                    //.style("color", "red")
                    //.style({
                    //  "background-color": "#ccc",
                    //    border: "solid 1px #000"
                    //}).attr("class", "item") 
                     changes.exit().remove();
        }
        
        
        function countData(error, data) {
            //console.log(countWords);
            //console.log(data.aggregations.TopWords.buckets);
            
            d3.select("#bars1").selectAll("*").remove();
            
            var data2=data.aggregations.TopWords.buckets;
            //console.log(data2[0].doc_count);
            
            svg_width=460;
            svg_height=460;
            height_bar=svg_height/data2.length;
            label_width=50;
            
            var chart = d3.select("#bars1")
            .attr("width", svg_width)
            .attr("height", svg_height);
            
            var x = d3.scale.linear()
            .domain([0, data2[0].doc_count])
            .range([0, svg_width-label_width]);
            
            
            
            //console.log(x)
            
          
            var bar_graph=chart.selectAll("rect")
            .data(data2,function(d) { return d.key});
            
            bar_graph.enter().append("rect")
            .attr("x", label_width )
            .attr("y", function(d, i) { return i * height_bar +2; })
            .attr("width", function(d) { return x(d.doc_count); })
            .attr("height", height_bar)
            .on("mouseover",function(d, i) {  highlight (d.key) })
            .on("mouseleave", function(d, i) {unHighlight (d.key)})
            .on("click", function(d, i) {clickBar(d.key)});
            
            bar_graph.enter().append("text")
            .attr("y", function(d, i) { return (i+1) * height_bar; })
            .attr("x", function(d) { return x(d.doc_count)+label_width; })
            .attr("dx", -3) // padding-right
            //.attr("dy", "1em") // vertical-align: middle
            .attr("text-anchor", "end") // text-align: right
            .text(function(d) { return d.doc_count; })
            .style("fill", "#ffffff")
            .style("font-size","10px");
            
            
            bar_graph.enter().append("text")
            .attr("y", function(d, i) { return (i+1) * height_bar; })
            .attr("x", label_width-5 )
            .attr("dx", 0) // padding-right
            //.attr("dy", "1em") // vertical-align: middle
            .attr("text-anchor", "end") // text-align: right
            .text(function(d) { return d.key; })
            .style("fill", "#000000")
            .style("font-size","10px");
            
            
            bar_graph.exit().remove();
            
            
            
            
        }
        
        function significantData(error, data) {
            //console.log(data.aggregations.TopWords.buckets);
            
            d3.select("#bars2").selectAll("*").remove();
            
            var data2=data.aggregations.TopWords.buckets;
            //console.log(data2[0].doc_count);
            
            svg_width=460;
            svg_height=460;
            height_bar=svg_height/data2.length;
            label_width=50;
            
            var chart = d3.select("#bars2")
            .attr("width", svg_width)
            .attr("height", svg_height);
            
            var x = d3.scale.linear()
            .domain([0, d3.round(data2[0].score,4)])
            .range([0, svg_width-label_width]);
            
            
            
            //console.log(x)
       
            var bar_graph=chart.selectAll("rect")
            .data(data2,function(d) { return d.key});
            
            bar_graph.enter().append("rect")
            .attr("x", label_width )
            .attr("y", function(d, i) { return i * height_bar; })
            .attr("width", function(d) { return x(d.score); })
            .attr("height", height_bar-2)
            .on("mouseover",function(d, i) {highlight (d.key) })
            .on("mouseleave", function(d, i) {unHighlight (d.key)})
            .on("click", function(d, i) {clickBar(d.key)});
            
            bar_graph.enter().append("text")
            .attr("y", function(d, i) { return (i+1) * height_bar; })
            .attr("x", function(d) { return x(d.score)+label_width; })
            .attr("dx", -3) // padding-right
            //.attr("dy", "1em") // vertical-align: middle
            .attr("text-anchor", "end") // text-align: right
            .text(function(d) { return d3.round(d.score,4); })
            .style("fill", "#ffffff");
            
            
            bar_graph.enter().append("text")
            .attr("y", function(d, i) { return (i+1) * height_bar; })
            .attr("x", label_width-5 )
            .attr("dx", 0) // padding-right
            //.attr("dy", "1em") // vertical-align: middle
            .attr("text-anchor", "end") // text-align: right
            .text(function(d) { return d.key; })
            .style("fill", "#000000")
            .style("font-size","10px");
            
            
            bar_graph.exit().remove();
        }

        
        //console.log(interval);
        
        
        // THIS
        function highlight(key){
            //console.log(key);
            d3.select("#bars1")
                .selectAll("rect")
                .style("fill", function(d, i) {
                    return d.key == key ? "green" : undefined
                })
                
            
           d3.select("#bars2")
                .selectAll("rect")
                .style("fill", function(d, i) {
                    return d.key == key ? "green" : undefined
                })
        }

        function unHighlight () {
            d3.select("#bars1")
                .selectAll("rect")
                .style("fill", undefined );
                
            
           d3.select("#bars2")
                .selectAll("rect")
                .style("fill", undefined );
        }
// END 
        
        function clickBar(key){
            
            countWords.query.terms.text.push(key);
        significantWords.query.terms.text.push(key); 
        query.query.terms.text.push(key);
            addButton(key);
        
            renderAll();
        }
        
        
    </script>
    
    
    
    
    






</html>